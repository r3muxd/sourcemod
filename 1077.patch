From 894954931a149d37ba575b1ec72aa090985ef86c Mon Sep 17 00:00:00 2001
From: Arthurdead <arthurdead@users.noreply.github.com>
Date: Sat, 7 Sep 2019 19:40:39 -0300
Subject: [PATCH 1/6] add portal2 support

---
 AMBuildScript | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/AMBuildScript b/AMBuildScript
index 96717edaf4..604ed9039b 100644
--- a/AMBuildScript
+++ b/AMBuildScript
@@ -51,7 +51,7 @@ PossibleSDKs = {
   'bgt':  SDK('HL2SDK-BGT', '2.bgt', '4', 'BLOODYGOODTIME', WinOnly, 'bgt'),
   'eye':  SDK('HL2SDK-EYE', '2.eye', '5', 'EYE', WinOnly, 'eye'),
   'csgo': SDK('HL2SDKCSGO', '2.csgo', '21', 'CSGO', CSGO, 'csgo'),
-  'portal2':  SDK('HL2SDKPORTAL2', '2.portal2', '17', 'PORTAL2', [], 'portal2'),
+  'portal2':  SDK('HL2SDKPORTAL2', '2.portal2', '17', 'PORTAL2', WinLinuxMac, 'portal2'),
   'blade':  SDK('HL2SDKBLADE', '2.blade', '18', 'BLADE', WinLinux, 'blade'),
   'insurgency':  SDK('HL2SDKINSURGENCY', '2.insurgency', '19', 'INSURGENCY', WinLinuxMac, 'insurgency'),
   'contagion':  SDK('HL2SDKCONTAGION', '2.contagion', '14', 'CONTAGION', WinOnly, 'contagion'),
@@ -572,7 +572,7 @@ class SMConfig(object):
       dynamic_libs = ['libtier0.dylib', 'libvstdlib.dylib']
     elif builder.target.platform == 'windows':
       libs = ['tier0', 'tier1', 'vstdlib', 'mathlib']
-      if sdk.name in ['swarm', 'blade', 'insurgency', 'doi', 'csgo']:
+      if sdk.name in ['swarm', 'blade', 'insurgency', 'doi', 'csgo', 'portal2']:
         libs.append('interfaces')
       for lib in libs:
         lib_path = os.path.join(sdk.path, 'lib', 'public', lib) + '.lib'

From 50206f590d8946d271a92e2cb117a7f7e6815181 Mon Sep 17 00:00:00 2001
From: Arthurdead <arthurdead@users.noreply.github.com>
Date: Sat, 7 Sep 2019 20:42:32 -0300
Subject: [PATCH 2/6] add portal2 gamedata

---
 gamedata/core.games/common.games.txt     |  3 +
 gamedata/core.games/game.portal2.txt     | 45 ++++++++++++
 gamedata/core.games/master.games.txt     |  5 ++
 gamedata/sdkhooks.games/game.portal2.txt | 89 ++++++++++++++++++++++++
 gamedata/sdkhooks.games/master.games.txt |  4 ++
 gamedata/sdktools.games/engine.swarm.txt |  3 +
 gamedata/sdktools.games/game.portal2.txt | 71 +++++++++++++++++++
 gamedata/sdktools.games/master.games.txt |  4 ++
 8 files changed, 224 insertions(+)
 create mode 100644 gamedata/core.games/game.portal2.txt
 create mode 100644 gamedata/sdkhooks.games/game.portal2.txt
 create mode 100644 gamedata/sdktools.games/game.portal2.txt

diff --git a/gamedata/core.games/common.games.txt b/gamedata/core.games/common.games.txt
index 270993aa16..f1f6305477 100644
--- a/gamedata/core.games/common.games.txt
+++ b/gamedata/core.games/common.games.txt
@@ -182,6 +182,7 @@
 			"game"					"doi"
 			"game"					"bms"
 			"game"					"iosoccer"
+			"game"					"portal2"
 		}
 
 		"Keys"
@@ -232,6 +233,7 @@
 			"game"					"doi"
 			"game"					"bms"
 			"game"					"iosoccer"
+			"game"					"portal2"
 		}
 		
 		"Keys"
@@ -291,6 +293,7 @@
 			"game"					"kz"
 			"game"					"csgo"
 			"game"					"reactivedrop"
+			"game"					"portal2"
 		}
 		
 		"Keys"
diff --git a/gamedata/core.games/game.portal2.txt b/gamedata/core.games/game.portal2.txt
new file mode 100644
index 0000000000..de396cfed7
--- /dev/null
+++ b/gamedata/core.games/game.portal2.txt
@@ -0,0 +1,45 @@
+/**
+ * Do not edit this file.  Any changes will be overwritten by the gamedata
+ * updater or by upgrading your SourceMod install.
+ *
+ * To override data in this file, create a subdirectory named "custom" and
+ * place your own gamedata file(s) inside of it.  Such files will be parsed
+ * after SM's own.
+ *
+ * For more information, see http://wiki.alliedmods.net/Gamedata_Updating_(SourceMod)
+ */
+
+"Games"
+{
+	/* CGlobalEntityList */
+	"#default"
+	{
+		"#supported"
+		{
+			"game"	"portal2"
+		}
+		
+		"Offsets"
+		{
+			/* Offset into LevelShutdown */
+			"gEntList"
+			{
+				"windows"	"16"
+			}
+
+			"EntInfo"
+			{
+				"windows"	"4"	
+			}
+		}
+		
+		"Signatures"
+		{
+			"LevelShutdown"
+			{
+				"library"	"server"
+				"windows"	"\x56\x8B\x35\x2A\x2A\x2A\x2A\x8B\x06\x8B\x50\x78\x8B\xCE"
+			}
+		}
+	}
+}
diff --git a/gamedata/core.games/master.games.txt b/gamedata/core.games/master.games.txt
index 6cda7526c2..007f981eb4 100644
--- a/gamedata/core.games/master.games.txt
+++ b/gamedata/core.games/master.games.txt
@@ -101,6 +101,11 @@
 		"game"		"dinodday"
 	}
 
+	"game.portal2.txt"
+	{
+		"game"		"portal2"
+	}
+
 	"blacklist.plugins.txt"
 	{
 	}
diff --git a/gamedata/sdkhooks.games/game.portal2.txt b/gamedata/sdkhooks.games/game.portal2.txt
new file mode 100644
index 0000000000..39af18a430
--- /dev/null
+++ b/gamedata/sdkhooks.games/game.portal2.txt
@@ -0,0 +1,89 @@
+"Games"
+{
+	"portal2"
+	{
+		"Offsets"
+		{
+			"EndTouch"
+			{
+				"windows"	"104"
+			}
+			"FireBullets"
+			{
+				"windows"	"117"
+			}
+			"GetMaxHealth"
+			{
+				"windows"	"121"
+			}
+			"OnTakeDamage"
+			{
+				"windows"	"67"
+			}
+			"PreThink"
+			{
+				"windows"	"348"
+			}
+			"PostThink"
+			{
+				"windows"	"349"
+			}
+			"SetTransmit"
+			{
+				"windows"	"22"
+			}
+			"ShouldCollide"
+			{
+				"windows"	"17"
+			}
+			"Spawn"
+			{
+				"windows"	"24"
+			}
+			"StartTouch"
+			{
+				"windows"	"102"
+			}
+			"Think"
+			{
+				"windows"	"51"
+			}
+			"Touch"
+			{
+				"windows"	"103"
+			}
+			"TraceAttack"
+			{
+				"windows"	"65"
+			}
+			"Use"
+			{
+				"windows"	"101"
+			}
+			"VPhysicsUpdate"
+			{
+				"windows"	"154"
+			}
+			"Weapon_CanSwitchTo"
+			{
+				"windows"	"289"
+			}
+			"Weapon_CanUse"
+			{
+				"windows"	"283"
+			}
+			"Weapon_Drop"
+			{
+				"windows"	"286"
+			}
+			"Weapon_Equip"
+			{
+				"windows"	"284"
+			}
+			"Weapon_Switch"
+			{
+				"windows"	"287"
+			}
+		}
+	}
+}
diff --git a/gamedata/sdkhooks.games/master.games.txt b/gamedata/sdkhooks.games/master.games.txt
index 70d45eefb8..db63d50071 100644
--- a/gamedata/sdkhooks.games/master.games.txt
+++ b/gamedata/sdkhooks.games/master.games.txt
@@ -199,4 +199,8 @@
 	{
 		"game"		"reactivedrop"
 	}
+	"game.portal2.txt"
+	{
+		"game"		"portal2"
+	}
 }
diff --git a/gamedata/sdktools.games/engine.swarm.txt b/gamedata/sdktools.games/engine.swarm.txt
index 0778924175..8d31cc836c 100644
--- a/gamedata/sdktools.games/engine.swarm.txt
+++ b/gamedata/sdktools.games/engine.swarm.txt
@@ -18,6 +18,7 @@
 		{
 			"game"		"swarm"
 			"game"		"dinodday"
+			"game"		"portal2"
 		}
 
 		"Offsets"
@@ -58,6 +59,7 @@
 		{
 			"game"		"swarm"
 			"game"		"dinodday"
+			"game"		"portal2"
 		}
 			
 		"Signatures"
@@ -117,6 +119,7 @@
 		{
 			"game"		"swarm"
 			"game"		"dinodday"
+			"game"		"portal2"
 		}
 		"Signatures"
 		{
diff --git a/gamedata/sdktools.games/game.portal2.txt b/gamedata/sdktools.games/game.portal2.txt
new file mode 100644
index 0000000000..cf780dc3e5
--- /dev/null
+++ b/gamedata/sdktools.games/game.portal2.txt
@@ -0,0 +1,71 @@
+"Games"
+{
+	"portal2"
+	{
+		"Offsets"
+		{
+			"GiveNamedItem"
+			{
+				"windows"	"433"
+			}
+			"RemovePlayerItem"
+			{
+				"windows"	"293"
+			}
+			"Weapon_GetSlot"
+			{
+				"windows"	"282"
+			}
+			"Ignite"
+			{
+				"windows"	"222"
+			}
+			"Extinguish"
+			{
+				"windows"	"225"
+			}
+			"Teleport"
+			{
+				"windows"	"113"
+			}
+			"CommitSuicide"
+			{
+				"windows"	"476"
+			}
+			"GetVelocity"
+			{
+				"windows"	"138"
+			}
+			"EyeAngles"
+			{
+				"windows"	"129"
+			}
+			"AcceptInput"
+			{
+				"windows"	"40"
+			}
+			"SetEntityModel"
+			{
+				"windows"	"26"
+			}
+			"WeaponEquip"
+			{
+				"windows"	"284"
+			}
+			"Activate"
+			{
+				"windows"	"37"
+			}
+			"PlayerRunCmd"
+			{
+				"windows"	"453"
+			}
+		}
+		
+		"Keys"
+		{
+			"GameRulesProxy"		"CPortalGameRulesProxy"
+			"GameRulesDataTable"	"portal_gamerules_data"
+		}
+	}
+}
\ No newline at end of file
diff --git a/gamedata/sdktools.games/master.games.txt b/gamedata/sdktools.games/master.games.txt
index 6f8a0e0fb7..27c96e9f00 100644
--- a/gamedata/sdktools.games/master.games.txt
+++ b/gamedata/sdktools.games/master.games.txt
@@ -259,4 +259,8 @@
 	{
 		"game"		"reactivedrop"
 	}
+	"game.portal2.txt"
+	{
+		"game"		"portal2"
+	}
 }

From 5704837774121dcd70b11f2ad90aa1546238d4eb Mon Sep 17 00:00:00 2001
From: Arthurdead <arthurdead@users.noreply.github.com>
Date: Sat, 7 Sep 2019 23:10:24 -0300
Subject: [PATCH 3/6] oops i did it wrong

---
 gamedata/core.games/common.games.txt          |   1 +
 .../{game.portal2.txt => engine.portal2.txt}  |   4 +-
 gamedata/core.games/master.games.txt          |  10 +-
 .../{game.portal2.txt => engine.portal2.txt}  |   0
 gamedata/sdkhooks.games/master.games.txt      |   9 +-
 gamedata/sdktools.games/engine.portal2.txt    | 174 ++++++++++++++++++
 gamedata/sdktools.games/engine.swarm.txt      |   3 -
 7 files changed, 187 insertions(+), 14 deletions(-)
 rename gamedata/core.games/{game.portal2.txt => engine.portal2.txt} (94%)
 rename gamedata/sdkhooks.games/{game.portal2.txt => engine.portal2.txt} (100%)
 create mode 100644 gamedata/sdktools.games/engine.portal2.txt

diff --git a/gamedata/core.games/common.games.txt b/gamedata/core.games/common.games.txt
index f1f6305477..c21bb84bdc 100644
--- a/gamedata/core.games/common.games.txt
+++ b/gamedata/core.games/common.games.txt
@@ -99,6 +99,7 @@
 			"engine"			"csgo"
 			"engine"			"sdk2013"
 			"engine"			"contagion"
+			"engine"			"portal2"
 		}
 		
 		"Offsets"
diff --git a/gamedata/core.games/game.portal2.txt b/gamedata/core.games/engine.portal2.txt
similarity index 94%
rename from gamedata/core.games/game.portal2.txt
rename to gamedata/core.games/engine.portal2.txt
index de396cfed7..e7afce3b61 100644
--- a/gamedata/core.games/game.portal2.txt
+++ b/gamedata/core.games/engine.portal2.txt
@@ -16,7 +16,7 @@
 	{
 		"#supported"
 		{
-			"game"	"portal2"
+			"game"		"portal2"
 		}
 		
 		"Offsets"
@@ -24,7 +24,7 @@
 			/* Offset into LevelShutdown */
 			"gEntList"
 			{
-				"windows"	"16"
+				"windows"	"11"
 			}
 
 			"EntInfo"
diff --git a/gamedata/core.games/master.games.txt b/gamedata/core.games/master.games.txt
index 007f981eb4..49eb07ed48 100644
--- a/gamedata/core.games/master.games.txt
+++ b/gamedata/core.games/master.games.txt
@@ -96,14 +96,14 @@
 		"engine"	"doi" // #cheating #yolo
 	}
 	
-	"game.dinodday.txt"
+	"engine.portal2.txt"
 	{
-		"game"		"dinodday"
+		"engine"	"portal2"
 	}
-
-	"game.portal2.txt"
+	
+	"game.dinodday.txt"
 	{
-		"game"		"portal2"
+		"game"		"dinodday"
 	}
 
 	"blacklist.plugins.txt"
diff --git a/gamedata/sdkhooks.games/game.portal2.txt b/gamedata/sdkhooks.games/engine.portal2.txt
similarity index 100%
rename from gamedata/sdkhooks.games/game.portal2.txt
rename to gamedata/sdkhooks.games/engine.portal2.txt
diff --git a/gamedata/sdkhooks.games/master.games.txt b/gamedata/sdkhooks.games/master.games.txt
index db63d50071..a77a1c92cb 100644
--- a/gamedata/sdkhooks.games/master.games.txt
+++ b/gamedata/sdkhooks.games/master.games.txt
@@ -71,6 +71,11 @@
 	}
 */
 	
+	"engine.portal2.txt"
+	{
+		"engine"	"portal2"
+	}
+
 	"game.insurgency.txt"
 	{
 		"game"		"$Insurgency"
@@ -199,8 +204,4 @@
 	{
 		"game"		"reactivedrop"
 	}
-	"game.portal2.txt"
-	{
-		"game"		"portal2"
-	}
 }
diff --git a/gamedata/sdktools.games/engine.portal2.txt b/gamedata/sdktools.games/engine.portal2.txt
new file mode 100644
index 0000000000..9baa56a770
--- /dev/null
+++ b/gamedata/sdktools.games/engine.portal2.txt
@@ -0,0 +1,174 @@
+/**
+ * Do not edit this file.  Any changes will be overwritten by the gamedata
+ * updater or by upgrading your SourceMod install.
+ *
+ * To override data in this file, create a subdirectory named "custom" and
+ * place your own gamedata file(s) inside of it.  Such files will be parsed
+ * after SM's own.
+ *
+ * For more information, see http://wiki.alliedmods.net/Gamedata_Updating_(SourceMod)
+ */
+
+"Games"
+{
+	/* General Temp Entities */
+	"#default"
+	{
+		"#supported"
+		{
+			"game"		"portal2"
+		}
+
+		"Offsets"
+		{
+			/* Offset into CBaseTempEntity constructor */
+			"s_pTempEntities"
+			{
+				"windows"	"17"
+			}
+			"GetTEName"
+			{
+				"windows"	"4"
+			}
+			"GetTENext"
+			{
+				"windows"	"8"
+			}
+			"TE_GetServerClass"
+			{
+				"windows"	"0"
+			}
+		}
+
+		"Signatures"
+		{
+			"CBaseTempEntity"
+			{
+				"library"	"server"
+				"windows"	"\x55\x8B\xEC\x8B\xC1\x8B\x4D\x08\xC7\x00\x2A\x2A\x2A\x2A\x89\x48\x04\x8B\x15\x2A\x2A\x2A\x2A"
+			}
+		}
+	}
+
+	/* CGlobalEntityList */
+	"#default"
+	{
+		"#supported"
+		{
+			"game"		"portal2"
+		}
+			
+		"Signatures"
+		{
+			/* Functions in CGlobalEntityList */
+			"FindEntityByClassname"
+			{
+				"library"	"server"
+				"windows"	"\x53\x55\x56\x8B\xF1\x8B\x4C\x24\x10\x85\xC9\x57\x74\x2E\x8B\x01\x8B\x50\x08\xFF\xD2\x8B\x00\x83\xF8\xFF\x75\x10\xB8\xFF\x1F\x00\x00\x83\xC0\x01\xC1\xE0\x04\x8B\x3C\x30\xEB\x16\x25\xFF\xFF\x00\x00\x83\xC0\x01\xC1\xE0\x04\x8B\x3C\x30\xEB\x06\x8B\xBE\x2A\x2A\x2A\x2A\x85\xFF\x74\x34\x8B"
+			}
+		}
+	}
+
+	/* IServer interface pointer */
+	"#default"
+	{
+		"Keys"
+		{
+			/* Signature for the beginning of IVEngineServer::CreateFakeClient.
+			 *
+			 * The engine binary is not actually scanned in order to look for
+			 * this. SourceHook is used to used to determine the address of the
+			 * function and this signature is used to verify that it contains
+			 * the expected code. A pointer to sv (IServer interface) is used
+			 * here.
+			 */
+			"CreateFakeClient_Windows"	"\x8B\x44\x24\x2A\x50\xB9\x2A\x2A\x2A\x2A\xE8"
+		}
+		
+		"Offsets"
+		{
+			/* Offset into IVEngineServer::CreateFakeClient */
+			"sv"
+			{
+				"windows"	"6"
+			}
+		}
+	}
+	
+	/* EntityFactoryDictionary function */
+	"#default"
+	{
+		"Signatures"
+		{
+			"EntityFactoryCaller"
+			{
+				"library"	"server"
+				"windows"	"\x55\x8B\xEC\x56\x8B\x75\x0C\x57\x8B\x7D\x08\x83\xFE\xFF"
+			}
+		}
+
+		"Offsets"
+		{
+			"EntityFactoryCallOffset"
+			{
+				"windows"	"55"
+			}
+		}
+	}
+
+	/* CBaseEntityOutput::FireOutput */
+	"#default"
+	{
+		"#supported"
+		{
+			"game"		"portal2"
+		}
+		"Signatures"
+		{
+			"FireOutput"
+			{
+				"library"	"server"
+				"windows"	"\x55\x8B\xEC\x81\xEC\x1C\x01\x00\x00\x53\x56\x8B\x71\x14"
+			}
+		}
+	}
+	
+	/* SetUserInfo data */
+	"#default"
+	{
+		"Offsets"
+		{
+			/**
+			 * CBaseClient::SetUserCVar(char  const*,char  const*);
+			 * Linux offset straight from VTable dump.
+			 * Windows offset is crazy. Found the windows SetName function using string "(%d)%-.*s" (aD_S in IDA)
+			 * Cross referenced back to the vtable and counted manually (SetUserCvar is 1 higher, offsets start from 1)
+			 */
+			"SetUserCvar"
+			{
+				/* Not 100% sure on this, why would windows change and not linux - TEST ME */
+				"windows"	"17"
+			}
+			/**
+			 * CBaseClient::SetName(char  const*);
+			 * Has string "(%d)%-0.*s"
+			 */
+			"SetClientName"
+			{
+				"windows"	"16"
+			}
+			/**
+			 * Offset into CBaseClient - Used by CBaseServer::UpdateUserSettings to determine when changes have been made.
+			 * Find CBaseClient::UpdateUserSettings (strings "net_maxroutable", "cl_updaterate" etc) and the offset is set to 0 near the end.
+			 * Linux: 	mov     byte ptr [esi+0B0h], 0
+			 * Win:		mov     byte ptr [esi+0B0h], 0
+			 *
+			 * L4D2/Swarm: This has been moved into CBaseClient::UpdateUserSettings(), rest of the details are still relevant.
+			 */
+			"InfoChanged"
+			{
+				"windows"	"176"
+			}
+		}
+	}
+}
diff --git a/gamedata/sdktools.games/engine.swarm.txt b/gamedata/sdktools.games/engine.swarm.txt
index 8d31cc836c..0778924175 100644
--- a/gamedata/sdktools.games/engine.swarm.txt
+++ b/gamedata/sdktools.games/engine.swarm.txt
@@ -18,7 +18,6 @@
 		{
 			"game"		"swarm"
 			"game"		"dinodday"
-			"game"		"portal2"
 		}
 
 		"Offsets"
@@ -59,7 +58,6 @@
 		{
 			"game"		"swarm"
 			"game"		"dinodday"
-			"game"		"portal2"
 		}
 			
 		"Signatures"
@@ -119,7 +117,6 @@
 		{
 			"game"		"swarm"
 			"game"		"dinodday"
-			"game"		"portal2"
 		}
 		"Signatures"
 		{

From f3c72bcc37ad0e9d50702d78478b8ec232a7ba89 Mon Sep 17 00:00:00 2001
From: Arthurdead <arthurdead@users.noreply.github.com>
Date: Sun, 8 Sep 2019 17:37:54 -0300
Subject: [PATCH 4/6] add partial linux and mac gamedata for portal2

---
 gamedata/core.games/engine.portal2.txt     | 10 ++++++
 gamedata/sdkhooks.games/engine.portal2.txt | 40 ++++++++++++++++++++++
 gamedata/sdktools.games/engine.portal2.txt | 39 +++++++++++++++++++++
 gamedata/sdktools.games/game.portal2.txt   | 28 +++++++++++++++
 tools/buildbot/PackageScript               |  4 +++
 5 files changed, 121 insertions(+)

diff --git a/gamedata/core.games/engine.portal2.txt b/gamedata/core.games/engine.portal2.txt
index e7afce3b61..8d13978de3 100644
--- a/gamedata/core.games/engine.portal2.txt
+++ b/gamedata/core.games/engine.portal2.txt
@@ -25,20 +25,30 @@
 			"gEntList"
 			{
 				"windows"	"11"
+				"linux"		"13"
 			}
 
 			"EntInfo"
 			{
 				"windows"	"4"	
+				"linux"		"4"
+				"mac"		"4"
 			}
 		}
 		
 		"Signatures"
 		{
+			"gEntList"
+			{
+				"library"	"server"
+				"mac"		"@gEntList"
+			}
+
 			"LevelShutdown"
 			{
 				"library"	"server"
 				"windows"	"\x56\x8B\x35\x2A\x2A\x2A\x2A\x8B\x06\x8B\x50\x78\x8B\xCE"
+				"linux"		"\x55\x89\xE5\x53\x83\xEC\x24\x8B\x1D\x2A\x2A\x2A\x2A\x8B\x03"
 			}
 		}
 	}
diff --git a/gamedata/sdkhooks.games/engine.portal2.txt b/gamedata/sdkhooks.games/engine.portal2.txt
index 39af18a430..a14cbbcd06 100644
--- a/gamedata/sdkhooks.games/engine.portal2.txt
+++ b/gamedata/sdkhooks.games/engine.portal2.txt
@@ -7,82 +7,122 @@
 			"EndTouch"
 			{
 				"windows"	"104"
+				"linux"		"105"
+				"mac"		"105"
 			}
 			"FireBullets"
 			{
 				"windows"	"117"
+				"linux"		"118"
+				"mac"		"118"
 			}
 			"GetMaxHealth"
 			{
 				"windows"	"121"
+				"linux"		"122"
+				"mac"		"122"
 			}
 			"OnTakeDamage"
 			{
 				"windows"	"67"
+				"linux"		"68"
+				"mac"		"68"
 			}
 			"PreThink"
 			{
 				"windows"	"348"
+				"linux"		"349"
+				"mac"		"349"
 			}
 			"PostThink"
 			{
 				"windows"	"349"
+				"linux"		"350"
+				"mac"		"350"
 			}
 			"SetTransmit"
 			{
 				"windows"	"22"
+				"linux"		"23"
+				"mac"		"23"
 			}
 			"ShouldCollide"
 			{
 				"windows"	"17"
+				"linux"		"18"
+				"mac"		"18"
 			}
 			"Spawn"
 			{
 				"windows"	"24"
+				"linux"		"25"
+				"mac"		"25"
 			}
 			"StartTouch"
 			{
 				"windows"	"102"
+				"linux"		"103"
+				"mac"		"103"
 			}
 			"Think"
 			{
 				"windows"	"51"
+				"linux"		"52"
+				"mac"		"52"
 			}
 			"Touch"
 			{
 				"windows"	"103"
+				"linux"		"104"
+				"mac"		"104"
 			}
 			"TraceAttack"
 			{
 				"windows"	"65"
+				"linux"		"66"
+				"mac"		"66"
 			}
 			"Use"
 			{
 				"windows"	"101"
+				"linux"		"102"
+				"mac"		"102"
 			}
 			"VPhysicsUpdate"
 			{
 				"windows"	"154"
+				"linux"		"155"
+				"mac"		"155"
 			}
 			"Weapon_CanSwitchTo"
 			{
 				"windows"	"289"
+				"linux"		"290"
+				"mac"		"290"
 			}
 			"Weapon_CanUse"
 			{
 				"windows"	"283"
+				"linux"		"284"
+				"mac"		"284"
 			}
 			"Weapon_Drop"
 			{
 				"windows"	"286"
+				"linux"		"287"
+				"mac"		"287"
 			}
 			"Weapon_Equip"
 			{
 				"windows"	"284"
+				"linux"		"285"
+				"mac"		"285"
 			}
 			"Weapon_Switch"
 			{
 				"windows"	"287"
+				"linux"		"288"
+				"mac"		"288"
 			}
 		}
 	}
diff --git a/gamedata/sdktools.games/engine.portal2.txt b/gamedata/sdktools.games/engine.portal2.txt
index 9baa56a770..74e18c9593 100644
--- a/gamedata/sdktools.games/engine.portal2.txt
+++ b/gamedata/sdktools.games/engine.portal2.txt
@@ -25,18 +25,26 @@
 			"s_pTempEntities"
 			{
 				"windows"	"17"
+				"linux"		"17"
+				"mac"		"17"
 			}
 			"GetTEName"
 			{
 				"windows"	"4"
+				"linux"		"4"
+				"mac"		"4"
 			}
 			"GetTENext"
 			{
 				"windows"	"8"
+				"linux"		"8"
+				"mac"		"8"
 			}
 			"TE_GetServerClass"
 			{
 				"windows"	"0"
+				"linux"		"0"
+				"mac"		"0"
 			}
 		}
 
@@ -46,6 +54,8 @@
 			{
 				"library"	"server"
 				"windows"	"\x55\x8B\xEC\x8B\xC1\x8B\x4D\x08\xC7\x00\x2A\x2A\x2A\x2A\x89\x48\x04\x8B\x15\x2A\x2A\x2A\x2A"
+				"linux"		""
+				"mac"		"@_ZN15CBaseTempEntityC2EPKc"
 			}
 		}
 	}
@@ -65,6 +75,8 @@
 			{
 				"library"	"server"
 				"windows"	"\x53\x55\x56\x8B\xF1\x8B\x4C\x24\x10\x85\xC9\x57\x74\x2E\x8B\x01\x8B\x50\x08\xFF\xD2\x8B\x00\x83\xF8\xFF\x75\x10\xB8\xFF\x1F\x00\x00\x83\xC0\x01\xC1\xE0\x04\x8B\x3C\x30\xEB\x16\x25\xFF\xFF\x00\x00\x83\xC0\x01\xC1\xE0\x04\x8B\x3C\x30\xEB\x06\x8B\xBE\x2A\x2A\x2A\x2A\x85\xFF\x74\x34\x8B"
+				"linux"		""
+				"mac"		"@_ZN17CGlobalEntityList21FindEntityByClassnameEP11CBaseEntityPKc"
 			}
 		}
 	}
@@ -83,6 +95,7 @@
 			 * here.
 			 */
 			"CreateFakeClient_Windows"	"\x8B\x44\x24\x2A\x50\xB9\x2A\x2A\x2A\x2A\xE8"
+			"CreateFakeClient_Linux"	""
 		}
 		
 		"Offsets"
@@ -91,6 +104,16 @@
 			"sv"
 			{
 				"windows"	"6"
+				"linux"		"11"
+			}
+		}
+
+		"Signatures"
+		{
+			"sv"
+			{
+				"library"	"server"
+				"mac"		"@sv"
 			}
 		}
 	}
@@ -104,6 +127,13 @@
 			{
 				"library"	"server"
 				"windows"	"\x55\x8B\xEC\x56\x8B\x75\x0C\x57\x8B\x7D\x08\x83\xFE\xFF"
+				"linux"		"\x55\x89\xE5\x83\xEC\x38\x89\x5D\xF4\x8B\x5D\x0C\x89\x75\xF8\x8B\x75\x08\x89\x7D\xFC\x0F\xB6\x7D\x10"
+			}
+
+			"EntityFactoryDictionary"
+			{
+				"library"	"server"
+				"mac"		"@_Z23EntityFactoryDictionaryv"
 			}
 		}
 
@@ -112,6 +142,7 @@
 			"EntityFactoryCallOffset"
 			{
 				"windows"	"55"
+				"linux"		"56"
 			}
 		}
 	}
@@ -129,6 +160,8 @@
 			{
 				"library"	"server"
 				"windows"	"\x55\x8B\xEC\x81\xEC\x1C\x01\x00\x00\x53\x56\x8B\x71\x14"
+				"linux"		"\x55\x89\xE5\x57\x56\x53\x81\xEC\x7C\x01\x00\x00\x8B\x55\x08\x8B\x75\x14"
+				"mac"		"@_ZN17CBaseEntityOutput10FireOutputE9variant_tP11CBaseEntityS2_f"
 			}
 		}
 	}
@@ -148,6 +181,8 @@
 			{
 				/* Not 100% sure on this, why would windows change and not linux - TEST ME */
 				"windows"	"17"
+				"linux"		"57"
+				"mac"		"57"
 			}
 			/**
 			 * CBaseClient::SetName(char  const*);
@@ -156,6 +191,8 @@
 			"SetClientName"
 			{
 				"windows"	"16"
+				"linux"		"56"
+				"mac"		"56"
 			}
 			/**
 			 * Offset into CBaseClient - Used by CBaseServer::UpdateUserSettings to determine when changes have been made.
@@ -168,6 +205,8 @@
 			"InfoChanged"
 			{
 				"windows"	"176"
+				"linux"		"176"
+				"mac"		"176"
 			}
 		}
 	}
diff --git a/gamedata/sdktools.games/game.portal2.txt b/gamedata/sdktools.games/game.portal2.txt
index cf780dc3e5..c0c1ca11e3 100644
--- a/gamedata/sdktools.games/game.portal2.txt
+++ b/gamedata/sdktools.games/game.portal2.txt
@@ -7,58 +7,86 @@
 			"GiveNamedItem"
 			{
 				"windows"	"433"
+				"linux"		"434"
+				"mac"		"434"
 			}
 			"RemovePlayerItem"
 			{
 				"windows"	"293"
+				"linux"		"294"
+				"mac"		"294"
 			}
 			"Weapon_GetSlot"
 			{
 				"windows"	"282"
+				"linux"		"283"
+				"mac"		"283"
 			}
 			"Ignite"
 			{
 				"windows"	"222"
+				"linux"		"223"
+				"mac"		"223"
 			}
 			"Extinguish"
 			{
 				"windows"	"225"
+				"linux"		"226"
+				"mac"		"226"
 			}
 			"Teleport"
 			{
 				"windows"	"113"
+				"linux"		"114"
+				"mac"		"114"
 			}
 			"CommitSuicide"
 			{
 				"windows"	"476"
+				"linux"		"477"
+				"mac"		"477"
 			}
 			"GetVelocity"
 			{
 				"windows"	"138"
+				"linux"		"139"
+				"mac"		"139"
 			}
 			"EyeAngles"
 			{
 				"windows"	"129"
+				"linux"		"130"
+				"mac"		"130"
 			}
 			"AcceptInput"
 			{
 				"windows"	"40"
+				"linux"		"41"
+				"mac"		"41"
 			}
 			"SetEntityModel"
 			{
 				"windows"	"26"
+				"linux"		"27"
+				"mac"		"27"
 			}
 			"WeaponEquip"
 			{
 				"windows"	"284"
+				"linux"		"285"
+				"mac"		"285"
 			}
 			"Activate"
 			{
 				"windows"	"37"
+				"linux"		"38"
+				"mac"		"38"
 			}
 			"PlayerRunCmd"
 			{
 				"windows"	"453"
+				"linux"		"454"
+				"mac"		"454"
 			}
 		}
 		
diff --git a/tools/buildbot/PackageScript b/tools/buildbot/PackageScript
index 88a075e3a8..6a926c17b8 100644
--- a/tools/buildbot/PackageScript
+++ b/tools/buildbot/PackageScript
@@ -182,6 +182,7 @@ CopyFiles('gamedata/sdkhooks.games', 'addons/sourcemod/gamedata/sdkhooks.games',
     'engine.ep2v.txt',
     'engine.insurgency.txt',
     'engine.l4d.txt',
+    'engine.portal2.txt',
     'game.ag2.txt',
     'game.alienswarm.txt',
     'game.aoc.txt',
@@ -230,6 +231,7 @@ CopyFiles('gamedata/sdktools.games', 'addons/sourcemod/gamedata/sdktools.games',
     'engine.l4d2.txt',
     'engine.sdk2013.txt',
     'engine.swarm.txt',
+    'engine.portal2.txt',
     'game.ag2.txt',
     'game.alienswarm.txt',
     'game.aoc.txt',
@@ -268,6 +270,7 @@ CopyFiles('gamedata/sdktools.games', 'addons/sourcemod/gamedata/sdktools.games',
     'game.tf.txt',
     'game.zm.txt',
     'game.zpanic.txt',
+    'game.portal2.txt',
     'master.games.txt',
   ]
 )
@@ -290,6 +293,7 @@ CopyFiles('gamedata/core.games', 'addons/sourcemod/gamedata/core.games',
     'engine.l4d2.txt',
     'engine.sdk2013.txt',
     'engine.swarm.txt',
+    'engine.portal2.txt',
     'game.dinodday.txt',
     'master.games.txt',
   ]

From 33d1d53a9d8c6eeef40ad93f8fd8fd42316ff4e4 Mon Sep 17 00:00:00 2001
From: arthurdead <arthur.kinder@gmail.com>
Date: Wed, 6 Nov 2019 08:42:53 -0300
Subject: [PATCH 5/6] portal2 linux support

---
 AMBuildScript | 22 ++++++++++++++++++++--
 1 file changed, 20 insertions(+), 2 deletions(-)

diff --git a/AMBuildScript b/AMBuildScript
index 604ed9039b..5829eec006 100644
--- a/AMBuildScript
+++ b/AMBuildScript
@@ -506,12 +506,30 @@ class SMConfig(object):
     if arch == 'x64':
       compiler.defines += ['X64BITS', 'PLATFORM_64BITS']
 
+    #!!TODO!! remove this eventually
+    if sdk.name in ['portal2']:
+      if compiler.family == 'gcc' or compiler.family == 'clang':
+        compiler.cxxflags += [
+          '-Wno-error',
+          '-Wno-reorder',
+          '-Wno-sign-compare',
+          '-Wno-class-memaccess',
+          '-Wno-address',
+          '-Wno-unknown-pragmas',
+          '-Wno-shift-count-negative',
+          '-Wno-return-type',
+          '-Wno-format',
+          '-Wno-nonnull-compare',
+        ]
+      if compiler.family == 'clang':
+        compiler.cxxflags += ['-Wno-macro-redefined']
+
     # For everything after Swarm, this needs to be defined for entity networking
     # to work properly with sendprop value changes.
     if sdk.name in ['blade', 'insurgency', 'doi', 'csgo']:
       compiler.defines += ['NETWORK_VARS_ENABLED']
 
-    if sdk.name in ['css', 'hl2dm', 'dods', 'sdk2013', 'bms', 'tf2', 'l4d', 'nucleardawn', 'l4d2']:
+    if sdk.name in ['css', 'hl2dm', 'dods', 'sdk2013', 'bms', 'tf2', 'l4d', 'nucleardawn', 'l4d2', 'portal2']:
       if builder.target.platform in ['linux', 'mac']:
         compiler.defines += ['NO_HOOK_MALLOC', 'NO_MALLOC_OVERRIDE']
 
@@ -559,7 +577,7 @@ class SMConfig(object):
 
     dynamic_libs = []
     if builder.target.platform == 'linux':
-      if sdk.name in ['css', 'hl2dm', 'dods', 'tf2', 'sdk2013', 'bms', 'nucleardawn', 'l4d2', 'insurgency', 'doi']:
+      if sdk.name in ['css', 'hl2dm', 'dods', 'tf2', 'sdk2013', 'bms', 'nucleardawn', 'l4d2', 'insurgency', 'doi', 'portal2']:
         dynamic_libs = ['libtier0_srv.so', 'libvstdlib_srv.so']
       elif arch == 'x64' and sdk.name == 'csgo':
         dynamic_libs = ['libtier0_client.so', 'libvstdlib_client.so']

From 3fc154048e326248468d64a3ccdd2a9b6502bd44 Mon Sep 17 00:00:00 2001
From: arthurdead <arthur.kinder@gmail.com>
Date: Wed, 6 Nov 2019 10:21:37 -0300
Subject: [PATCH 6/6] wrong vstdlib

---
 AMBuildScript | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/AMBuildScript b/AMBuildScript
index 5829eec006..58c60e30ec 100644
--- a/AMBuildScript
+++ b/AMBuildScript
@@ -577,11 +577,11 @@ class SMConfig(object):
 
     dynamic_libs = []
     if builder.target.platform == 'linux':
-      if sdk.name in ['css', 'hl2dm', 'dods', 'tf2', 'sdk2013', 'bms', 'nucleardawn', 'l4d2', 'insurgency', 'doi', 'portal2']:
+      if sdk.name in ['css', 'hl2dm', 'dods', 'tf2', 'sdk2013', 'bms', 'nucleardawn', 'l4d2', 'insurgency', 'doi']:
         dynamic_libs = ['libtier0_srv.so', 'libvstdlib_srv.so']
       elif arch == 'x64' and sdk.name == 'csgo':
         dynamic_libs = ['libtier0_client.so', 'libvstdlib_client.so']
-      elif sdk.name in ['l4d', 'blade', 'insurgency', 'doi', 'csgo']:
+      elif sdk.name in ['l4d', 'blade', 'insurgency', 'doi', 'csgo', 'portal2']:
         dynamic_libs = ['libtier0.so', 'libvstdlib.so']
       else:
         dynamic_libs = ['tier0_i486.so', 'vstdlib_i486.so']
